
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>faye小手机</title>
<style>
/* CSS样式 */
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 0;
  background-color: transparent;
  user-select: none;
  -webkit-user-select: none;
  min-height: 100vh;
  overflow: hidden;
}
/* 手机容器 */
#phone-container {
  width: 350px;
  height: 650px;
  max-width: 95vw;
  max-height: 95vh;
  border: 12px solid #333;
  border-radius: 50px;
  background: #fff;
  background-size: cover;
  background-position: center;
  box-shadow:
    inset 0 0 0 2px rgba(0,0,0,0.1),
    0 20px 50px rgba(0, 0, 0, 0.3);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
  transition: width 0.3s, height 0.3s, border-color 0.3s;
  box-sizing: content-box;
}
/* --- 灵动岛 --- */
.status-bar {
  position: absolute; top: 0; left: 0; width: 100%; height: 50px;
  display: flex; justify-content: space-between; align-items: flex-start;
  padding-top: 14px; padding-left: 26px; padding-right: 26px; box-sizing: border-box;
  z-index: 100; font-size: 14px; font-weight: 600; pointer-events: none; transition: color 0.3s;
}
.status-bar.text-dark { color: #000; } .status-bar.text-dark svg { fill: #000; }
.status-bar.text-light { color: #fff; } .status-bar.text-light svg { fill: #fff; }
.sb-left { width: 60px; text-align: center; }
.sb-right { width: 60px; display: flex; justify-content: center; align-items: center; gap: 6px; }
.dynamic-island {
  width: 96px; height: 28px; background-color: #000; border-radius: 14px;
  position: absolute; left: 50%; top: 10px; transform: translateX(-50%); z-index: 101;
  display: flex; justify-content: flex-end; align-items: center; padding-right: 10px; pointer-events: auto;
}
.island-camera {
  width: 10px; height: 10px; background: #1a1a1a; border-radius: 50%;
  box-shadow: inset 0 0 3px rgba(255,255,255,0.2);
}
/* --- 屏幕管理 --- */
.screen {
  flex: 1; display: flex; flex-direction: column; width: 100%; height: 100%;
  position: absolute; top: 0; left: 0; background-size: cover; background-position: center;
  transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1), opacity 0.4s, filter 0.4s; 
  overflow: hidden;
  background-color: #fff;
}
#home-screen { 
  z-index: 1; padding-top: 90px; align-items: flex-start; background-color: #f2f2f7; 
  transform: translateX(0); opacity: 1;
}
#home-screen.slide-out { 
  transform: translateX(-30%); 
  opacity: 0.8; 
  filter: brightness(0.8);
  pointer-events: none; 
}
#chat-screen, #settings-screen { 
  z-index: 10; 
  transform: translateX(100%); 
  box-shadow: -5px 0 15px rgba(0,0,0,0.05);
}
#chat-screen.visible, #settings-screen.visible { 
  transform: translateX(0); 
}
.app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px 15px; padding: 0 24px; width: 100%; box-sizing: border-box; }
.app-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; position: relative; }
.app-item:active { opacity: 0.7; transform: scale(0.95); transition: 0.1s; }
.app-icon-box {
  width: 60px; height: 60px; border-radius: 16px; display: flex; align-items: center; justify-content: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1); background: #fff; transition: background 0.3s;
}
.app-icon-box svg { width: 32px; height: 32px; transition: fill 0.3s; }
.app-name { font-size: 12px; font-weight: 500; text-shadow: 0 1px 3px rgba(0,0,0,0.3); color: #fff; }
.app-header {
  height: 95px; padding-top: 50px; display: flex; align-items: center;
  padding-left: 15px; padding-right: 15px; background-color: #ededed;
  border-bottom: 1px solid #dcdcdc; flex-shrink: 0; z-index: 10; box-sizing: border-box;
}
.header-content { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; position: relative; }
.header-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: flex-start; cursor: pointer; position: absolute; left: 0; }
.header-btn svg { width: 24px; height: 24px; fill: #181818; }
.header-title { font-size: 17px; font-weight: 600; color: #181818; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center; max-width: 70%; }
#chat-messages {
  flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px;
  scroll-behavior: smooth; scrollbar-width: none;
}
#chat-messages::-webkit-scrollbar { display: none; }
.settings-body {
  flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
  background: #f2f2f7;
}
.settings-body::-webkit-scrollbar { display: none; }
.message-row { display: flex; align-items: flex-start; gap: 8px; width: 100%; flex-shrink: 0; }
.message-row.sent { flex-direction: row-reverse; }
.message-row.received { flex-direction: row; }
.avatar { width: 38px; height: 38px; border-radius: 6px; background-color: #e0e0e0; object-fit: cover; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.05); margin-top: 0; }
.msg-container { display: flex; flex-direction: column; max-width: 75%; }
.message-row.sent .msg-container { align-items: flex-end; }
.message-row.received .msg-container { align-items: flex-start; }
.msg-name {
  font-size: 12px; color: #999; margin-bottom: 2px; margin-left: 2px; margin-right: 2px;
  max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.msg-wrapper { display: flex; flex-direction: row; align-items: flex-end; gap: 6px; margin-top: 2px; }
.message-row.sent .msg-wrapper { flex-direction: row-reverse; }
.message-row.received .msg-wrapper { flex-direction: row; }
.msg-thought {
  font-size: 10px; color: #777; background-color: #f9f9f9; border-radius: 14px;
  padding: 4px 8px; margin-top: 1px; line-height: 1.3; word-wrap: break-word; max-width: 100%; box-sizing: border-box;
}
.message-row.sent .msg-thought { text-align: left; }
.message-row.received .msg-thought { text-align: left; }
.bubble, .location-card, .transfer-card, .file-card, .voice-card, .photo-card {
  flex-shrink: 0; cursor: pointer; position: relative; transition: transform 0.1s; max-width: 100%;
}
.bubble.pressing, .location-card.pressing, .transfer-card.pressing, .file-card.pressing, .voice-card.pressing, .photo-card.pressing {
  transform: scale(0.98); filter: brightness(0.95);
}
.bubble { padding: 7px 14px; border-radius: 18px; line-height: 1.5; word-wrap: break-word; font-size: 14px; }
.bubble-sent { background: #95ec69; color: #000; border-top-right-radius: 0px; }
.bubble-received { background: #ffffff; color: #000; box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05); border-top-left-radius: 0px; }
.msg-time {
  font-size: 10px; color: #b0b0b0; line-height: 1; user-select: none; padding: 0 2px;
  margin-bottom: 2px; flex-shrink: 0; min-width: 28px;
}
.message-row.sent .msg-time { text-align: right; }
.message-row.received .msg-time { text-align: left; }
.photo-card { border-radius: 6px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 0; }
.photo-card img { width: 100%; height: auto; display: block; }
.voice-card {
  padding: 7px 12px; border-radius: 18px; display: flex; flex-direction: column; gap: 4px; min-width: 28px; position: relative;
}
.voice-card.sent { background: #95ec69; color: #000; border-top-right-radius: 0px; }
.voice-card.received { background: #ffffff; color: #000; box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05); border-top-left-radius: 0px; }
.voice-bar { display: flex; align-items: center; gap: 8px; height: 20px; }
.voice-card.sent .voice-bar { flex-direction: row-reverse; }
.voice-duration { font-size: 14px; font-weight: 500; min-width: 25px; text-align: center; }
.voice-waves { display: flex; align-items: center; gap: 3px; height: 100%; flex: 1; }
.wave { width: 2px; background-color: currentColor; border-radius: 1px; opacity: 0.8; }
.voice-text {
  font-size: 13px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1);
  display: none; white-space: pre-wrap; line-height: 1.4; text-align: left; word-break: break-all;
}
.voice-card.show-text .voice-text { display: block; }
.voice-card.sent .voice-text { text-align: right; }
.voice-card.sent .voice-text.multiline { text-align: left; }
.location-card, .transfer-card, .file-card { width: 200px; }
.location-card { background: white; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #eee; }
.location-info { padding: 8px 10px; background: #fff; }
.location-name { font-size: 13px; color: #333; font-weight: 500; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.location-map { width: 100%; height: 60px; background-color: #f2f2f2; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="220" height="90" viewBox="0 0 220 90"><rect width="220" height="90" fill="%23f2f2f2"/><path d="M-10,30 Q50,10 110,30 T230,30" stroke="%23ddd" stroke-width="6" fill="none"/><path d="M30,90 Q60,50 90,90" stroke="%23ddd" stroke-width="6" fill="none"/><path d="M150,0 Q180,40 210,0" stroke="%23ddd" stroke-width="6" fill="none"/><circle cx="110" cy="45" r="4" fill="%23ea4e3d"/></svg>'); background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; }
.location-pin { width: 20px; height: 20px; fill: #ea4e3d; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); margin-bottom: 8px; }
.transfer-card { background: #ffacac; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.transfer-top { padding: 12px; display: flex; align-items: center; gap: 10px; }
.transfer-icon-circle { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #fff; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.transfer-icon-circle svg { width: 20px; height: 20px; stroke: #fff; stroke-width: 2; fill: none; }
.transfer-content { flex: 1; color: #fff; display: flex; flex-direction: column; overflow: hidden; }
.transfer-amount { font-size: 15px; font-weight: bold; }
.transfer-note { font-size: 11px; opacity: 0.9; margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.transfer-bottom { background: #fff; padding: 4px 12px; font-size: 10px; color: #999; }
.file-card { background: white; border-radius: 6px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; border: 1px solid #eee; }
.file-info { flex: 1; overflow: hidden; }
.file-name { font-size: 13px; color: #333; font-weight: 500; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3; word-break: break-all; }
.file-size { font-size: 9px; color: #999; margin-top: 3px; }
.file-icon { width: 34px; height: 34px; flex-shrink: 0; }
.file-icon svg { width: 100%; height: 100%; fill: #ddd; }
#input-bar {
  display: flex; padding: 10px; border-top: 1px solid #e5e5e5;
  background: #f7f7f7; align-items: flex-end; flex-shrink: 0; z-index: 10;
}
#input-bar textarea {
  flex: 1; border: none; border-radius: 4px; padding: 10px;
  font-size: 15px; resize: none; max-height: 80px; outline: none; min-height: 20px; background: #fff;
}
#input-bar button {
  margin-left: 8px; padding: 0 12px; height: 38px; border: none;
  border-radius: 4px; font-size: 14px; font-weight: 500;
  cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;
}
#send-button { background: #07c160; color: white; }
#send-button:hover { background: #06ad56; }
#plus-button {
  background: transparent; color: #333; border: 1px solid #777; width: 42px; height: 28px; border-radius: 6px;
  padding: 0; margin-left: 0; margin-right: 10px; margin-bottom: 5px; font-size: 20px; line-height: 1; display: flex;
  align-items: center; justify-content: center;
}
#plus-button:hover { background: #dedede; }
#action-menu {
  height: 0; background: #f7f7f7; border-top: 1px solid #e5e5e5; transition: height 0.2s ease; overflow: hidden;
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 0 20px; flex-shrink: 0; z-index: 10;
}
#action-menu.open { height: 220px; padding: 25px 20px; }
.action-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; color: #666; font-size: 12px; }
.action-icon-box { width: 55px; height: 55px; background: #fff; border-radius: 16px; display: flex; align-items: center; justify-content: center; border: 1px solid #e5e5e5; }
.modal-overlay {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center;
  z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
.modal-overlay.show { opacity: 1; pointer-events: auto; }
.modal-box {
  width: 280px; background: #fff; border-radius: 12px; padding: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 15px;
  transform: scale(0.9); transition: transform 0.2s; max-height: 85%; overflow-y: auto; scrollbar-width: none;
}
.modal-box.large-modal { width: 320px; }
.modal-box::-webkit-scrollbar { display: none; }
.modal-overlay.show .modal-box { transform: scale(1); }
.modal-title { font-size: 18px; font-weight: bold; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 5px; }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
.modal-btn { padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; border: none; font-weight: 500; }
.btn-cancel { background: #f0f0f0; color: #333; }
.btn-confirm { background: #07c160; color: white; }
#modal-inputs-container { display: flex; flex-direction: column; gap: 12px; }
.modal-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; box-sizing: border-box; outline: none; }
.modal-input:focus { border-color: #07c160; }
.settings-section-title { font-size: 12px; color: #999; font-weight: bold; text-transform: uppercase; margin-top: 10px; margin-bottom: 5px; }
.setting-group { background: #fff; border-radius: 8px; padding: 0; display: flex; flex-direction: column; border: 1px solid #e5e5e5; overflow: hidden; }
.setting-row { 
  display: grid; grid-template-columns: 1fr auto; align-items: center; font-size: 15px; color: #000; gap: 10px; 
  padding: 12px 15px; border-bottom: 1px solid #f0f0f0;
}
.setting-row:last-child { border-bottom: none; }
.setting-row > div { display: flex; align-items: center; gap: 8px; justify-content: flex-end; }
.color-picker { width: 28px; height: 28px; border: 1px solid #ddd; padding: 0; border-radius: 50%; overflow: hidden; cursor: pointer; }
.color-picker::-webkit-color-swatch-wrapper { padding: 0; }
.color-picker::-webkit-color-swatch { border: none; border-radius: 50%; }
.setting-input-sm { width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center; }
.file-upload-label { font-size: 12px; background: #f2f2f7; border: 1px solid #ddd; padding: 5px 10px; border-radius: 14px; cursor: pointer; display: inline-flex; align-items: center; transition: background 0.2s; }
.file-upload-label:active { background: #e5e5ea; }
.file-upload-input { display: none; }
.preview-img { width: 32px; height: 32px; border-radius: 6px; object-fit: cover; background: #eee; border: 1px solid #ddd; }
.delete-btn {
  position: absolute; top: -6px; right: -6px; width: 18px; height: 18px;
  background-color: #c0c0c0; color: #fff; border-radius: 50%;
  display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10;
}
.delete-btn svg { width: 10px; height: 10px; stroke: currentColor; stroke-width: 3; }
.typing-dots span {
  display: inline-block; width: 6px; height: 6px; background-color: #888;
  border-radius: 50%; margin: 0 2px; animation: typing 1.4s infinite ease-in-out both;
}
.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }
@keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
</style>
</head>
<body>
<div id="phone-container">
<div class="status-bar text-dark" id="status-bar">
  <div class="sb-left" id="clock">12:00</div>
  <div class="dynamic-island"><div class="island-camera"></div></div>
  <div class="sb-right">
    <svg width="17" height="11" viewBox="0 0 17 11" fill="currentColor"><path d="M1 9.5h2v-2H1v2zm4-4h2v6H5v-6zm4-3h2v9H9v-9zm4-3h2v12h-2V-.5z"></path></svg>
    <svg width="22" height="11" viewBox="0 0 25 11" fill="currentColor"><rect x="0.5" y="0.5" width="20" height="10" rx="2.5" stroke="currentColor"></rect><path d="M23 4v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path><rect x="2.5" y="2.5" width="16" height="6" rx="1" fill="currentColor"></rect></svg>
  </div>
</div>
<div id="home-screen" class="screen">
  <div class="app-grid">
    <div class="app-item" onclick="openChat()">
      <div class="app-icon-box app-icon-style"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"></path></svg></div>
      <span class="app-name">Chat</span>
    </div>
    <div class="app-item" onclick="openSettings()">
      <div class="app-icon-box app-icon-style"><svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L3.16 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"></path></svg></div>
      <span class="app-name">设置</span>
    </div>
  </div>
</div>
<div id="chat-screen" class="screen">
  <div class="app-header">
    <div class="header-content">
      <div class="header-btn" onclick="goBack()"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg></div>
      <span class="header-title" id="header-title">Chat</span>
    </div>
  </div>
  <div id="chat-messages"></div>
  <div id="input-bar">
    <button id="plus-button" title="更多功能">+</button>
    <textarea id="message-input" placeholder="输入消息..." rows="1"></textarea>
    <button id="send-button">发送</button>
  </div>
  <input type="file" id="photo-upload-input" accept="image/*" style="display: none;">
  <div id="action-menu">
    <div class="action-item" onclick="handleAction('photo')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></div><span>照片</span></div>
    <div class="action-item" onclick="handleAction('voice')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></div><span>语音</span></div>
    <div class="action-item" onclick="handleAction('location')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></div><span>位置</span></div>
    <div class="action-item" onclick="handleAction('transfer')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M7 10h14l-4-4"></path><path d="M17 14H3l4 4"></path></svg></div><span>转账</span></div>
    <div class="action-item" onclick="openChatSettings()"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></div><span>设置</span></div>
    <div class="action-item" onclick="handleAction('file')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></div><span>文件</span></div>
  </div>
</div>
<div id="settings-screen" class="screen">
  <div class="app-header">
    <div class="header-content">
      <div class="header-btn" onclick="closeSettings()"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg></div>
      <span class="header-title">手机设置</span>
    </div>
  </div>
  <div class="settings-body">
    <div class="settings-section-title" style="margin-top:0">外观与硬件</div>
    <div class="setting-group">
      <div class="setting-row"><label>手机尺寸 (宽x高)</label> <div><input type="number" id="set-phone-w" class="setting-input-sm" placeholder="350"> x <input type="number" id="set-phone-h" class="setting-input-sm" placeholder="650"></div></div>
      <div class="setting-row"><label>手机壳颜色</label> <input type="color" id="set-case-color" class="color-picker"></div>
    </div>
    <div class="settings-section-title">主屏幕</div>
    <div class="setting-group">
      <div class="setting-row"><label>主屏壁纸</label> <div><label class="file-upload-label">选择图片<input type="file" id="set-home-bg" accept="image/*" class="file-upload-input" data-target="home"></label></div></div>
      <div class="setting-row"><label>图标底色</label> <input type="color" id="set-icon-bg" class="color-picker"></div>
      <div class="setting-row"><label>图标图案颜色</label> <input type="color" id="set-icon-color" class="color-picker"></div>
    </div>
    <div class="modal-actions" style="justify-content: center; margin-top: 30px; padding-bottom: 30px;">
        <button class="modal-btn btn-confirm" style="width: 100%; padding: 12px;" onclick="saveHomeSettings()">保存并应用</button>
    </div>
  </div>
</div>
<div id="input-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-title" id="modal-title">输入内容</div>
    <div id="modal-inputs-container"></div>
    <div class="modal-actions"><button class="modal-btn btn-cancel" onclick="closeModal()">取消</button><button class="modal-btn btn-confirm" id="modal-confirm-btn">发送</button></div>
  </div>
</div>
<div id="chat-settings-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-title">聊天设置</div>
    <div class="settings-section-title">聊天界面</div>
    <div class="setting-group">
      <div class="setting-row"><label>聊天背景</label> <label class="file-upload-label">选择图片<input type="file" id="set-chat-bg" accept="image/*" class="file-upload-input" data-target="chat"></label></div>
      <div class="setting-row"><label>对方气泡/文字</label> <div><input type="color" id="set-char-bubble" class="color-picker"> <input type="color" id="set-char-text" class="color-picker"></div></div>
      <div class="setting-row"><label>对方头像</label> <div><label class="file-upload-label">上传<input type="file" id="set-char-avatar" accept="image/*" class="file-upload-input" data-target="charAvatar"></label> <img id="preview-char-avatar" class="preview-img"></div></div>
      <div class="setting-row"><label>我方气泡/文字</label> <div><input type="color" id="set-user-bubble" class="color-picker"> <input type="color" id="set-user-text" class="color-picker"></div></div>
      <div class="setting-row"><label>我方头像</label> <div><label class="file-upload-label">上传<input type="file" id="set-user-avatar" accept="image/*" class="file-upload-input" data-target="userAvatar"></label> <img id="preview-user-avatar" class="preview-img"></div></div>
    </div>
    <div class="modal-actions"><button class="modal-btn btn-cancel" onclick="closeModal()">取消</button><button class="modal-btn btn-confirm" onclick="saveChatSettings()">保存配置</button></div>
  </div>
</div>
</div>

<script>
  window.openChat = openChat; window.goBack = goBack; window.openSettings = openSettings; window.closeSettings = closeSettings;
  window.openChatSettings = openChatSettings; window.saveHomeSettings = saveHomeSettings; window.saveChatSettings = saveChatSettings;
  window.handleAction = handleAction; window.closeModal = closeModal;

  const phoneContainer = document.getElementById('phone-container');
  const homeScreen = document.getElementById('home-screen');
  const chatScreen = document.getElementById('chat-screen');
  const settingsScreen = document.getElementById('settings-screen');
  const chatMessages = document.getElementById('chat-messages');
  const messageInput = document.getElementById('message-input');
  const sendButton = document.getElementById('send-button');
  const plusButton = document.getElementById('plus-button');
  const actionMenu = document.getElementById('action-menu');
  const modal = document.getElementById('input-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalInputsContainer = document.getElementById('modal-inputs-container');
  const modalConfirmBtn = document.getElementById('modal-confirm-btn');
  const chatSettingsModal = document.getElementById('chat-settings-modal');
  const headerTitle = document.getElementById('header-title');
  const clockEl = document.getElementById('clock');
  const statusBar = document.getElementById('status-bar');
  const photoInput = document.getElementById('photo-upload-input');

  let activeDeleteBtn = null;
  let stName = 'User'; let stCharName = 'Character';
  
  // Default Settings
  let appSettings = {
    charBubble: '#ffffff', charText: '#000000', charAvatar: '',
    userBubble: '#95ec69', userText: '#000000', userAvatar: '',
    chatBg: '', chatBgIsDark: false,
    homeBg: '', homeBgIsDark: false,
    iconBg: '#ffffff', iconColor: '#333333',
    caseColor: '#333333', phoneWidth: '350', phoneHeight: '650'
  };

  // --- Listener for Parent (ST Extension) ---
  window.addEventListener('message', (event) => {
    if (!event.data) return;
    
    // 1. Handshake & Init
    if (event.data.type === 'init_phone') {
        stName = event.data.userName || 'User';
        stCharName = event.data.charName || 'Character';
        if(headerTitle) headerTitle.textContent = stCharName;
        
        // If parent sent avatars/bgs, load them (as Base64 for display)
        if(event.data.userAvatar) appSettings.userAvatar = event.data.userAvatar;
        if(event.data.charAvatar) appSettings.charAvatar = event.data.charAvatar;
        applySettings();
        
        // Reply to confirm
        window.parent.postMessage({ type: 'phone_ready' }, '*');
    }
    
    // 2. Load History from ST (Already formatted string)
    if (event.data.type === 'load_history') {
        chatMessages.innerHTML = '';
        const rawText = event.data.content; 
        parseMessages(rawText).forEach(msg => renderMessageToUI(msg));
    }
    
    // 3. Receive Uploaded Image URL from Parent
    if (event.data.type === 'upload_success') {
        // Determine what to do based on context
        const url = event.data.url; // This is the local ST URL
        const context = event.data.context; // 'chat_photo' or 'setting_bg' etc.
        
        if (context === 'chat_photo') {
            // Send message with URL, but display Base64 preview if available
            sendPhotoMessage(url, event.data.base64Preview);
        } 
        // Settings updates are handled by just saving the URL in settings
        else if (context === 'userAvatar') { appSettings.userAvatar = event.data.base64Preview; document.getElementById('preview-user-avatar').src = appSettings.userAvatar; }
        else if (context === 'charAvatar') { appSettings.charAvatar = event.data.base64Preview; document.getElementById('preview-char-avatar').src = appSettings.charAvatar; }
        else if (context === 'home') { appSettings.homeBg = event.data.base64Preview; analyzeImageBrightness(appSettings.homeBg).then(d => appSettings.homeBgIsDark = d); }
        else if (context === 'chat') { appSettings.chatBg = event.data.base64Preview; analyzeImageBrightness(appSettings.chatBg).then(d => appSettings.chatBgIsDark = d); }
    }
  });

  // Request Init on Load
  setTimeout(() => window.parent.postMessage({ type: 'request_init' }, '*'), 500);

  function openChat() { homeScreen.classList.add('slide-out'); chatScreen.classList.add('visible'); updateStatusBar('chat'); setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 300); }
  function goBack() { closeActionMenu(); chatScreen.classList.remove('visible'); homeScreen.classList.remove('slide-out'); updateStatusBar('home'); }
  function openSettings() {
    document.getElementById('set-phone-w').value = appSettings.phoneWidth;
    document.getElementById('set-phone-h').value = appSettings.phoneHeight;
    document.getElementById('set-case-color').value = appSettings.caseColor;
    document.getElementById('set-icon-bg').value = appSettings.iconBg;
    document.getElementById('set-icon-color').value = appSettings.iconColor;
    homeScreen.classList.add('slide-out'); settingsScreen.classList.add('visible'); updateStatusBar('settings');
  }
  function closeSettings() { settingsScreen.classList.remove('visible'); homeScreen.classList.remove('slide-out'); updateStatusBar('home'); }

  function updateClock() { const now = new Date(); clockEl.textContent = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`; }
  setInterval(updateClock, 1000);

  function updateStatusBar(screen) {
    let isDark = false;
    if (screen === 'home') isDark = appSettings.homeBgIsDark; else if (screen === 'chat') isDark = appSettings.chatBgIsDark; else if (screen === 'settings') isDark = false;
    if (screen === 'home' && !appSettings.homeBg) isDark = false; if (screen === 'chat' && !appSettings.chatBg) isDark = false;
    statusBar.className = isDark ? 'status-bar text-light' : 'status-bar text-dark';
  }

  function analyzeImageBrightness(base64) {
    return new Promise((resolve) => {
      if (!base64 || !base64.startsWith('data:')) { resolve(false); return; }
      const img = new Image(); img.src = base64;
      img.onload = () => {
        const canvas = document.createElement('canvas'); canvas.width = 50; canvas.height = 50;
        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 50, 50);
        const data = ctx.getImageData(0,0,50,50).data; let r=0,g=0,b=0;
        for(let i=0; i<data.length; i+=4) { r+=data[i]; g+=data[i+1]; b+=data[i+2]; }
        resolve(((r+g+b)/(3*(data.length/4))) < 128);
      };
      img.onerror = () => resolve(false);
    });
  }

  function init() {
    const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NjYyI+PHBhdGggZD0iTTEyIDEyYzIuMjEgMC00LTEuNzktNC00czEuNzktNCA0LTQgNCAxLjc5IDQgNCAxLjc5IDQgNCA0em0wIDJjLTIuNjcgMC04IDEuMzQtOCA0djJoMTZ2LTJjMC0yLjY2LTUuMzMtNC04LTR6Ii8+PC9zdmc+';
    if(!appSettings.charAvatar) appSettings.charAvatar = defaultAvatar;
    if(!appSettings.userAvatar) appSettings.userAvatar = defaultAvatar;
    applySettings();
    if(headerTitle) headerTitle.textContent = stCharName;
    updateClock();
  }

  function applySettings() {
    phoneContainer.style.width = (appSettings.phoneWidth || 350) + 'px';
    phoneContainer.style.height = (appSettings.phoneHeight || 650) + 'px';
    phoneContainer.style.borderColor = appSettings.caseColor;
    if (appSettings.homeBg) homeScreen.style.backgroundImage = `url(${appSettings.homeBg})`; else { homeScreen.style.backgroundImage = 'none'; homeScreen.style.backgroundColor = '#f2f2f7'; }
    if (appSettings.chatBg) { chatScreen.style.backgroundImage = `url(${appSettings.chatBg})`; chatScreen.style.backgroundColor = 'rgba(249, 249, 249, 0.8)'; } else { chatScreen.style.backgroundImage = 'none'; chatScreen.style.backgroundColor = '#fff'; }
    document.querySelectorAll('.app-icon-style').forEach(el => { el.style.background = appSettings.iconBg; el.querySelector('svg').style.fill = appSettings.iconColor; });
    updateStatusBar('home');
  }

  // Helper to upload to parent
  async function uploadToParent(file, context) {
    const base64 = await toBase64(file);
    window.parent.postMessage({
        type: 'upload_image',
        file: base64,
        fileName: file.name,
        context: context
    }, '*');
  }

  // Handle Settings Saves - Now just applies visual settings, images are handled by listeners
  async function saveHomeSettings() {
    appSettings.phoneWidth = document.getElementById('set-phone-w').value || 350;
    appSettings.phoneHeight = document.getElementById('set-phone-h').value || 650;
    appSettings.caseColor = document.getElementById('set-case-color').value;
    appSettings.iconBg = document.getElementById('set-icon-bg').value;
    appSettings.iconColor = document.getElementById('set-icon-color').value;
    applySettings(); closeSettings();
  }

  async function saveChatSettings() {
    appSettings.charBubble = document.getElementById('set-char-bubble').value;
    appSettings.charText = document.getElementById('set-char-text').value;
    appSettings.userBubble = document.getElementById('set-user-bubble').value;
    appSettings.userText = document.getElementById('set-user-text').value;
    applySettings(); closeModal(); closeActionMenu();
  }

  // Generic File Input Listener for Settings
  document.querySelectorAll('.file-upload-input').forEach(input => {
      input.addEventListener('change', (e) => {
          if(e.target.files[0]) {
              const ctx = e.target.dataset.target; // 'home', 'chat', 'userAvatar', etc.
              uploadToParent(e.target.files[0], ctx);
          }
      });
  });

  function closeModal() { modal.classList.remove('show'); chatSettingsModal.classList.remove('show'); currentConfirmAction = null; }
  function toBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); }); }

  // Chat Photo Input
  photoInput.addEventListener('change', async (e) => {
    if (e.target.files && e.target.files[0]) {
      uploadToParent(e.target.files[0], 'chat_photo');
      e.target.value = '';
    }
  });

  plusButton.addEventListener('click', () => { if (actionMenu.classList.contains('open')) closeActionMenu(); else { actionMenu.classList.add('open'); plusButton.classList.add('active'); clearDeleteButton(); setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 300); } });
  function closeActionMenu() { actionMenu.classList.remove('open'); plusButton.classList.remove('active'); }
  messageInput.addEventListener('focus', closeActionMenu);

  function handleAction(type) {
    if (type === 'location') openModal('发送位置', [{ placeholder: '请输入地点名称' }], (v) => sendLocation(v[0]));
    else if (type === 'transfer') openModal('转账给对方', [{ placeholder: '金额 (例如：¥ 520.00)' }, { placeholder: '添加备注 (可选)' }], (v) => sendTransfer(v[0], v[1]));
    else if (type === 'file') openModal('发送文件', [{ placeholder: '请输入文件名称 (例如：报告.pdf)' }], (v) => sendFile(v[0]));
    else if (type === 'voice') openModal('发送语音', [{ placeholder: '时长 (秒)' }, { placeholder: '语音转文字内容' }], (v) => sendVoice(v[0], v[1]));
    else if (type === 'settings') openChatSettings();
    else if (type === 'photo') photoInput.click();
  }

  let currentConfirmAction = null;
  function openModal(title, fields, confirmCallback) {
    modalTitle.textContent = title; modalInputsContainer.innerHTML = '';
    fields.forEach(field => { const input = document.createElement('input'); input.type = 'text'; input.className = 'modal-input'; input.placeholder = field.placeholder; modalInputsContainer.appendChild(input); });
    currentConfirmAction = confirmCallback; modal.classList.add('show'); modalInputsContainer.querySelector('input').focus();
  }
  modalConfirmBtn.addEventListener('click', () => { if (currentConfirmAction) { const inputs = modalInputsContainer.querySelectorAll('input'); const values = Array.from(inputs).map(i => i.value.trim()); if (values[0]) { currentConfirmAction(values); closeModal(); closeActionMenu(); } } });

  // Send Message Handlers - Pass message to Parent to save in history
  function sendToParentHistory(msgObj) {
    // Send the formatted message to parent to inject into chat
    window.parent.postMessage({
        type: 'send_chat_message',
        message: msgObj
    }, '*');
  }

  async function sendLocation(addr) { 
      const t = getTime(); 
      const msg = { header: `[${stName}|位置|${t}]`, body: addr, isUser: true, type: 'location' };
      renderMessageToUI(msg); 
      sendToParentHistory(msg); 
  }
  async function sendTransfer(amt, note) { 
      const t = getTime(); 
      const msg = { header: `[${stName}|转账|${t}]`, body: `${amt}|${note||''}`, isUser: true, type: 'transfer' };
      renderMessageToUI(msg);
      sendToParentHistory(msg); 
  }
  async function sendFile(fn) { 
      const t = getTime(); 
      const msg = { header: `[${stName}|文件|${t}]`, body: fn, isUser: true, type: 'file' };
      renderMessageToUI(msg);
      sendToParentHistory(msg);
  }
  async function sendVoice(dur, txt) { 
      const t = getTime(); 
      const msg = { header: `[${stName}|语音|${t}]`, body: `${dur}|${txt||''}`, isUser: true, type: 'voice' };
      renderMessageToUI(msg);
      sendToParentHistory(msg);
  }
  
  // Triggered after successful upload
  async function sendPhotoMessage(url, previewBase64) { 
      const t = getTime(); 
      // Render with Base64 so it shows up immediately in the iframe
      renderMessageToUI({ header: `[${stName}|图片|${t}]`, body: previewBase64 || url, isUser: true, type: 'photo' });
      // But save the URL to history
      sendToParentHistory({ header: `[${stName}|图片|${t}]`, body: url, isUser: true, type: 'photo' });
  }

  async function sendMessage() {
    closeActionMenu(); const text = messageInput.value.trim();
    if (!text) return;
    const t = getTime();
    const msg = { header: `[${stName}|${t}]`, body: text, isUser: true };
    renderMessageToUI(msg);
    messageInput.value = ''; adjustTextareaHeight();
    sendToParentHistory(msg);
  }

  function getTime() { const now = new Date(); return `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`; }

  function renderMessageToUI(msg) {
    const isUser = msg.isUser !== undefined ? msg.isUser : (msg.header && (msg.header.startsWith('User') || msg.header.includes(stName) || msg.header.includes('User')));
    const row = document.createElement('div'); row.className = `message-row ${isUser ? 'sent' : 'received'}`;
    const avatar = document.createElement('img'); avatar.className = 'avatar'; avatar.src = isUser ? appSettings.userAvatar : appSettings.charAvatar;
    
    const container = document.createElement('div'); container.className = 'msg-container';
    const nameEl = document.createElement('div'); nameEl.className = 'msg-name';
    
    let displayName = isUser ? stName : stCharName;
    if (msg.header) { const parts = msg.header.replace(/^\[|\]$/g, '').split('|'); if (parts.length > 0 && parts[0]) displayName = parts[0]; }
    nameEl.textContent = displayName;
    container.appendChild(nameEl);

    const wrapper = document.createElement('div'); wrapper.className = 'msg-wrapper';
    let el;
    const isLoc = msg.type === 'location' || (msg.header && msg.header.includes('位置'));
    const isTra = msg.type === 'transfer' || (msg.header && msg.header.includes('转账'));
    const isFile = msg.type === 'file' || (msg.header && msg.header.includes('文件'));
    const isVoice = msg.type === 'voice' || (msg.header && msg.header.includes('语音'));
    const isPhoto = msg.type === 'photo' || (msg.header && msg.header.includes('图片'));

    const timeMatch = msg.header ? msg.header.match(/\|(\d{2}:\d{2})/) : null;
    const timeStr = timeMatch ? timeMatch[1] : getTime();
    const timeEl = document.createElement('div'); timeEl.className = 'msg-time'; timeEl.textContent = timeStr;

    let displayBody = msg.body;
    let displayThought = msg.thought || '';
    if (!displayThought && displayBody && !displayBody.startsWith('data:')) {
       const thoughtMatch = displayBody.match(/^([\s\S]*?)\*([^\*]+)\*\s*$/);
       if (thoughtMatch) { displayBody = thoughtMatch[1].trim(); displayThought = thoughtMatch[2].trim(); }
    }

    if (isLoc) {
      el = document.createElement('div'); el.className = `location-card ${isUser ? 'sent' : 'received'}`;
      el.innerHTML = `<div class="location-info"><div class="location-name">${displayBody}</div></div><div class="location-map"><svg class="location-pin" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"></path><circle cx="12" cy="9" r="2.5" fill="#fff"/></svg></div>`;
    } else if (isTra) {
      const parts = displayBody.split('|');
      el = document.createElement('div'); el.className = `transfer-card ${isUser ? 'sent' : 'received'}`;
      el.innerHTML = `<div class="transfer-top"><div class="transfer-icon-circle"><svg viewBox="0 0 24 24"><path d="M7 10h14l-4-4"></path><path d="M17 14H3l4 4"></path></svg></div><div class="transfer-content"><div class="transfer-amount">${parts[0]||'¥ 0.00'}</div><div class="transfer-note">${parts[1]||'转账给您'}</div></div></div><div class="transfer-bottom">转账</div>`;
    } else if (isFile) {
      el = document.createElement('div'); el.className = `file-card ${isUser ? 'sent' : 'received'}`;
      el.innerHTML = `<div class="file-info"><div class="file-name">${displayBody}</div><div class="file-size">128 KB</div></div><div class="file-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" fill="#eee"></path><polyline points="14 2 14 8 20 8" fill="#ddd"></polyline><text x="50%" y="18" font-size="6" fill="#888" text-anchor="middle" font-family="Arial">FILE</text></svg></div>`;
    } else if (isVoice) {
      const parts = displayBody.split('|'); const dur = parseInt(parts[0]) || 5; const txt = parts.slice(1).join('|');
      const width = Math.max(60, 40 + txt.length * 10);
      el = document.createElement('div'); el.className = `voice-card ${isUser ? 'sent' : 'received'}`;
      el.style.width = width + 'px';
      let waves = ''; for(let i=0;i<4;i++) waves += `<div class="wave" style="height:${8 + Math.random()*8}px"></div>`;
      el.innerHTML = `<div class="voice-bar"><div class="voice-duration">${dur}"</div><div class="voice-waves">${waves}</div></div><div class="voice-text ${txt.length > 15 ? 'multiline' : ''}">${txt}</div>`;
      el.onclick = (e) => { if(!activeDeleteBtn) el.classList.toggle('show-text'); };
      if (isUser) { el.style.backgroundColor = appSettings.userBubble; el.style.color = appSettings.userText; } else { el.style.backgroundColor = appSettings.charBubble; el.style.color = appSettings.charText; }
    } else if (isPhoto) {
      el = document.createElement('div'); el.className = `photo-card ${isUser ? 'sent' : 'received'}`;
      el.innerHTML = `<img src="${displayBody}">`;
    } else {
      el = document.createElement('div'); el.className = `bubble ${isUser ? 'bubble-sent' : 'bubble-received'}`; el.textContent = displayBody;
      if (isUser) { el.style.backgroundColor = appSettings.userBubble; el.style.color = appSettings.userText; } else { el.style.backgroundColor = appSettings.charBubble; el.style.color = appSettings.charText; }
    }
    
    if (msg.header) el.dataset.fullHeader = msg.header.startsWith('[') ? msg.header : `[${msg.header}]`;
    else { const n = isUser ? stName : stCharName; const t = new Date().toTimeString().slice(0,5); el.dataset.fullHeader = `[${n}|${t}]`; }
    
    addLongPressHandler(el); wrapper.appendChild(el); wrapper.appendChild(timeEl); container.appendChild(wrapper);

    if (displayThought) {
        const thoughtEl = document.createElement('div'); thoughtEl.className = 'msg-thought';
        thoughtEl.textContent = displayThought; container.appendChild(thoughtEl);
    }

    row.appendChild(avatar); row.appendChild(container);
    chatMessages.appendChild(row); chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function parseMessages(txt) {
    const lines = txt.split('\n'), res = [], dr = /^\d{1,2}月\d{1,2}日$/, hr = /^\[([^\]]+)\]/, cn = stCharName;
    for (const l of lines) {
      const tr = l.trim(); if (!tr) continue; if (dr.test(tr)) { res.push({ type: 'date', body: tr }); continue; }
      const m = tr.match(hr);
      if (m) {
        const hc = m[1]; let b = tr.substring(m[0].length).trim(); let thought = '';
        const thoughtMatch = b.match(/^([\s\S]*?)\*([^\*]+)\*\s*$/);
        if (thoughtMatch) { b = thoughtMatch[1].trim(); thought = thoughtMatch[2].trim(); }
        let type = 'text';
        if (hc.includes('位置')) type = 'location'; else if (hc.includes('转账')) type = 'transfer'; else if (hc.includes('文件')) type = 'file'; else if (hc.includes('语音')) type = 'voice'; else if (hc.includes('图片')) type = 'photo';
        res.push({ header: hc, body: b, type: type, thought: thought });
      } else res.push({ header: `${cn}|00:00`, body: tr, type: 'text' });
    }
    return res;
  }

  function adjustTextareaHeight() { messageInput.style.height = 'auto'; messageInput.style.height = messageInput.scrollHeight + 'px'; }
  function clearDeleteButton() { if (activeDeleteBtn) { activeDeleteBtn.remove(); activeDeleteBtn = null; } document.querySelectorAll('.delete-mode').forEach(el => el.classList.remove('delete-mode')); }
  function executeDelete(el) { const r = el.parentElement.parentElement.parentElement; r.style.transform = 'scale(0)'; setTimeout(async () => { r.remove(); clearDeleteButton(); }, 200); }
  function addLongPressHandler(el) {
    let timer; const start = (e) => { if(e.target.closest('.delete-btn')) return; el.classList.add('pressing'); timer = setTimeout(() => { el.classList.remove('pressing'); showDeleteButton(el); }, 500); };
    const cancel = () => { clearTimeout(timer); el.classList.remove('pressing'); }; el.addEventListener('mousedown', start); el.addEventListener('touchstart', start, {passive:true}); ['mouseup','mouseleave','touchend','touchmove'].forEach(ev => el.addEventListener(ev, cancel));
  }
  function showDeleteButton(el) {
    clearDeleteButton(); el.classList.add('delete-mode'); const btn = document.createElement('div'); btn.className = 'delete-btn';
    btn.innerHTML = `<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
    btn.onclick = (e) => { e.stopPropagation(); executeDelete(el); }; el.appendChild(btn); activeDeleteBtn = btn;
  }
  document.onclick = (e) => { if(activeDeleteBtn && !e.target.closest('.location-card, .transfer-card, .file-card, .bubble, .voice-card, .photo-card')) clearDeleteButton(); };
  sendButton.onclick = sendMessage; messageInput.oninput = adjustTextareaHeight; messageInput.onkeydown = (e) => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
  
  init();
</script>
</body>
</html>
