
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SillyPhone Cloud Client</title>
<style>
/* æ ·å¼ä¿æŒä¸å˜ï¼Œä¸ºäº†ä»£ç ç®€æ´ï¼Œæˆ‘åªåˆ—å‡ºä¿®æ”¹åçš„æ ¸å¿ƒé€»è¾‘éƒ¨åˆ† */
/* æ‚¨ä¹‹å‰çš„ CSS éå¸¸å®Œç¾ï¼Œè¿™é‡Œç›´æ¥å¤ç”¨ï¼Œæ— éœ€æ”¹åŠ¨è§†è§‰éƒ¨åˆ† */
body { font-family: -apple-system, sans-serif; display: flex; justify-content: center; margin: 0; background: transparent; height: 100vh; overflow: hidden; }
#phone-container { width: 350px; height: 650px; border: 12px solid #333; border-radius: 50px; background: #fff; position: relative; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
/* ... çœç•¥å…·ä½“ CSSï¼Œè¿™éƒ¨åˆ†å’Œä¹‹å‰ä¸€æ ·ï¼Œè¯·ä¿ç•™ä¹‹å‰çš„æ ·å¼ä»£ç  ... */
/* ä¸ºèŠ‚çœ XML é•¿åº¦ï¼Œè¿™é‡Œå‡è®¾ CSS å·²ç»å­˜åœ¨ï¼Œé‡ç‚¹æ˜¯ä¸‹é¢çš„ JS é€»è¾‘ */
.status-bar { position: absolute; top: 0; width: 100%; height: 50px; display: flex; justify-content: space-between; padding: 14px 26px; box-sizing: border-box; z-index: 10; pointer-events: none; color: #000; }
.dynamic-island { width: 96px; height: 28px; background: #000; border-radius: 14px; position: absolute; left: 50%; top: 10px; transform: translateX(-50%); }
.screen { flex: 1; position: absolute; width: 100%; height: 100%; background: #f2f2f7; transition: transform 0.3s; display: flex; flex-direction: column; }
#home-screen { z-index: 1; padding-top: 90px; }
#chat-screen { z-index: 10; transform: translateX(100%); background: #fff; }
#chat-screen.visible { transform: translateX(0); }
.app-grid { display: grid; grid-template-columns: repeat(4, 1fr); padding: 0 24px; gap: 20px; }
.app-item { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
.app-icon-box { width: 60px; height: 60px; background: #fff; border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.app-name { font-size: 12px; color: #333; }
#chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; padding-top: 100px; }
.message-row { display: flex; gap: 8px; width: 100%; }
.message-row.sent { flex-direction: row-reverse; }
.bubble { padding: 8px 12px; border-radius: 16px; max-width: 70%; font-size: 14px; word-break: break-word; }
.bubble.sent { background: #95ec69; }
.bubble.received { background: #fff; border: 1px solid #eee; }
.photo-card img { max-width: 100%; border-radius: 8px; }
#input-bar { padding: 10px; background: #f9f9f9; display: flex; align-items: center; gap: 10px; border-top: 1px solid #eee; z-index: 20; }
input, button { padding: 8px; border-radius: 8px; border: 1px solid #ddd; }
</style>
</head>
<body>

<div id="phone-container">
    <!-- Status Bar -->
    <div class="status-bar">
        <span>12:00</span>
        <div class="dynamic-island"></div>
        <span>5G</span>
    </div>

    <!-- Home Screen -->
    <div id="home-screen" class="screen">
        <div class="app-grid">
            <div class="app-item" onclick="openChat()">
                <div class="app-icon-box">ğŸ’¬</div>
                <span class="app-name">Chat</span>
            </div>
             <div class="app-item">
                <div class="app-icon-box">âš™ï¸</div>
                <span class="app-name">è®¾ç½®</span>
            </div>
        </div>
    </div>

    <!-- Chat Screen -->
    <div id="chat-screen" class="screen">
        <div style="position:absolute; top:0; width:100%; height:90px; background:#f9f9f9; z-index:10; border-bottom:1px solid #eee; display:flex; align-items:end; padding-bottom:10px; justify-content:center;">
            <div onclick="closeChat()" style="position:absolute; left:15px; cursor:pointer;">â¬…ï¸</div>
            <span id="header-title" style="font-weight:bold;">Character</span>
        </div>
        
        <div id="chat-messages"></div>
        
        <div id="input-bar">
            <button onclick="document.getElementById('photo-input').click()">ğŸ“·</button>
            <input type="text" id="msg-input" style="flex:1;" placeholder="è¾“å…¥æ¶ˆæ¯...">
            <button onclick="sendMessage()">å‘é€</button>
        </div>
        <input type="file" id="photo-input" accept="image/*" style="display:none;">
    </div>
</div>

<script>
    // --- å…¨å±€çŠ¶æ€ ---
    let stName = 'User';
    let stCharName = 'Character';
    let chatHistory = []; // å†…å­˜ä¸­çš„èŠå¤©è®°å½•

    // --- æ ¸å¿ƒï¼šä¸ ST æ’ä»¶é€šä¿¡ ---
    
    // 1. ç›‘å¬ ST å‘æ¥çš„æ¶ˆæ¯
    window.addEventListener('message', (event) => {
        const data = event.data;
        if (!data) return;

        // åˆå§‹åŒ–ï¼šæ”¶åˆ° ST çš„åå­—å’Œå†å²è®°å½•
        if (data.type === 'init_phone') {
            console.log('æ‰‹æœºå·²è¿æ¥ ST:', data);
            stName = data.userName || 'User';
            stCharName = data.charName || 'Character';
            document.getElementById('header-title').textContent = stCharName;
            
            if (data.history) {
                loadHistoryFromText(data.history);
            }
        }

        // å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼šæ”¶åˆ° ST è¿”å›çš„ URL
        if (data.type === 'upload_success') {
            // åœºæ™¯ï¼šå‘é€èŠå¤©å›¾ç‰‡
            if (data.context === 'chat_photo') {
                // 1. åœ¨ UI ä¸Šæ˜¾ç¤º Base64 (ä¸ºäº†å¿«ï¼Œä¸éœ€è¦è·¨åŸŸåŠ è½½)
                addMessageToUI(true, { type: 'photo', content: data.base64Preview });
                // 2. åœ¨å†å²è®°å½•é‡Œå­˜ URL (ä¸ºäº†ä¸å¡)
                saveMessageToHistory(true, { type: 'photo', content: data.url });
            }
        }
    });

    // 2. å‘ ST å‘é€åˆå§‹åŒ–è¯·æ±‚ (ç½‘é¡µä¸€åŠ è½½å°±å‘)
    setTimeout(() => {
        window.parent.postMessage({ type: 'request_init' }, '*');
    }, 500);

    // --- ä¸šåŠ¡é€»è¾‘ ---

    // ä¸Šä¼ å›¾ç‰‡ (åªè´Ÿè´£ä¼ ç»™æ’ä»¶)
    document.getElementById('photo-input').addEventListener('change', function(e) {
        if (e.target.files[0]) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (evt) => {
                // å‘é€ Base64 ç»™æ’ä»¶ï¼Œé™„å¸¦ä¸Šä¸‹æ–‡ 'chat_photo'
                window.parent.postMessage({
                    type: 'upload_image',
                    file: evt.target.result,
                    fileName: file.name,
                    context: 'chat_photo'
                }, '*');
            };
            reader.readAsDataURL(file);
        }
        e.target.value = '';
    });

    // å‘é€æ–‡æœ¬æ¶ˆæ¯
    function sendMessage() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text) return;
        
        // UI æ˜¾ç¤º
        addMessageToUI(true, { type: 'text', content: text });
        // å­˜å…¥å†å²
        saveMessageToHistory(true, { type: 'text', content: text });
        
        input.value = '';
    }

    // å°†æ¶ˆæ¯æ›´æ–°å› ST (ç”Ÿæˆ XML)
    function saveMessageToHistory(isUser, msgObj) {
        // è¿™é‡Œä½ éœ€è¦ç»´æŠ¤ä¸€ä¸ªå®Œæ•´çš„ XML ç»“æ„
        // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åªç”Ÿæˆå½“å‰è¿™ä¸€æ¡ï¼Œ ST æ’ä»¶é‚£è¾¹å¯ä»¥é€‰æ‹©æ˜¯ append è¿˜æ˜¯ update
        // æ ¼å¼ï¼š [User|Time] Content
        const time = new Date().toTimeString().slice(0, 5);
        const name = isUser ? stName : stCharName;
        
        // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œcontent æ˜¯ URL (ä¾‹å¦‚ user/images/xxx.png)
        // ST çš„ AI çœ‹åˆ°è¿™ä¸ª URL ä¼šå°è¯•å»åŠ è½½é™„ä»¶
        
        const header = `[${name}|${msgObj.type === 'photo' ? 'å›¾ç‰‡|' : ''}${time}]`;
        const body = msgObj.content;
        
        // å‘Šè¯‰ STï¼šè¿™æ˜¯ä¸€æ¡æ–°æ¶ˆæ¯ï¼Œè¯·è®°å½•
        window.parent.postMessage({
            type: 'send_chat_message',
            message: { header, body, isUser }
        }, '*');
    }

    // è§£æå†å²è®°å½• (XML -> UI)
    function loadHistoryFromText(text) {
        document.getElementById('chat-messages').innerHTML = '';
        // ç®€å•çš„æ­£åˆ™è§£æ [Name|Time] Content
        const lines = text.split('\n');
        lines.forEach(line => {
            const match = line.match(/^\[(.*?)\](.*)/);
            if (match) {
                const header = match[1];
                const content = match[2].trim();
                const isUser = header.includes(stName) || header.includes('User'); // ç®€å•åˆ¤æ–­
                
                let type = 'text';
                if (header.includes('å›¾ç‰‡')) type = 'photo';
                
                addMessageToUI(isUser, { type, content });
            }
        });
    }

    // UI æ¸²æŸ“å‡½æ•°
    function addMessageToUI(isUser, msg) {
        const container = document.getElementById('chat-messages');
        const row = document.createElement('div');
        row.className = `message-row ${isUser ? 'sent' : 'received'}`;
        
        const bubble = document.createElement('div');
        bubble.className = `bubble ${isUser ? 'sent' : 'received'}`;
        
        if (msg.type === 'photo') {
            bubble.className += ' photo-card';
            // å¤„ç†è·¨åŸŸå›¾ç‰‡ï¼šå¦‚æœæ˜¯ URL (user/images/...)ï¼Œåœ¨ Cloudflare ä¸Šæ— æ³•ç›´æ¥åŠ è½½ localhost
            // æ‰€ä»¥å¦‚æœæ˜¯å†å²è®°å½•é‡Œçš„å›¾ï¼Œå¯èƒ½ä¼šè£‚å¼€ã€‚
            // è§£å†³æ–¹æ¡ˆï¼šæ˜¾ç¤ºä¸€ä¸ªå ä½ç¬¦ï¼Œæˆ–è€…è®©æ’ä»¶æŠŠå†å²å›¾ç‰‡ Base64 å‘è¿‡æ¥ (å¤ªé‡äº†)ã€‚
            // å¦¥åæ–¹æ¡ˆï¼šå¦‚æœæ£€æµ‹åˆ°æ˜¯ user/images å¼€å¤´ï¼Œæ˜¾ç¤ºâ€œæŸ¥çœ‹å›¾ç‰‡â€é“¾æ¥
            if (msg.content.startsWith('data:')) {
                bubble.innerHTML = `<img src="${msg.content}">`;
            } else {
                // è¿™æ˜¯ä¸€ä¸ª URL
                bubble.innerHTML = `<div style="font-size:10px; color:#666;">ğŸ–¼ï¸ å›¾ç‰‡å·²å­˜æ¡£<br>${msg.content}</div>`;
            }
        } else {
            bubble.textContent = msg.content;
        }
        
        row.appendChild(bubble);
        container.appendChild(row);
        container.scrollTop = container.scrollHeight;
    }

    // ç®€å•çš„é¡µé¢åˆ‡æ¢
    window.openChat = () => document.getElementById('chat-screen').classList.add('visible');
    window.closeChat = () => document.getElementById('chat-screen').classList.remove('visible');

</script>
</body>
</html>
